<!doctype html>
<html xmlns:fb="http://ogp.me/ns/fb#">
  <head>
    <title>AdvisorConnect</title>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Lato:100,300,400,700,900,400italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="./css/gh-buttons.css" />
    <link rel="stylesheet" href="./css/main.css" />

    <link rel='apple-touch-icon' href="">

    <meta name='title' content='' />
    <meta name='description' content='' />
    <meta name='keywords' content='' />

    <!-- Google Site Verification -->
    <meta name='google-site-verification' content="" />

    <!-- Facebook Open Graph -->
    <meta property="fb:admins" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:title" content="" />
    <meta property="og:url" content="" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content="" />
    <meta property="og:image" content="" />
    <meta property="fb:page_id" content="" />
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script type="text/javascript" src="//platform.linkedin.com/in.js">
        api_key:   77kimruenyqspn
        authorize: true
        onLoad: onLinkedInLoad
    </script>        
    <script>
      $(function() {
        $.get("./geolocations.txt", function(data) {
            var items = data.split('"');
            $( "#geolocation" ).autocomplete({
              source: items
            });            
        });        
      });
    </script>
  </head>
  <body>
    <script>
      window.fbAsyncInit = function() {
        FB.init({
          appId      : '1608721912712330',
          xfbml      : true,
          version    : 'v2.4'
        });        
      };
      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "https://connect.facebook.net/en_US/sdk.js";
         fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));

    </script>
    <script type="text/javascript">
        
        // Setup an event listener to make an API call once auth is complete
        function onLinkedInLoad() {
// $('a[id*=li_ui_li_gen_]').css({marginBottom:'20px'}) 
//        .html('<img src="/images/shared/linkedin-register-large.png" height="31" width="200" border="0" />');           
            IN.Event.on(IN, "auth", getProfileData);
        }

        // Handle the successful return from the API call
        function onSuccess(data) {
            console.log(data);
            geolocation = data.location.name;
            public_url = data.publicProfileUrl;
            email_address = data.emailAddress;
            firstName = data.firstName;
            document.getElementById("owner_email").innerHTML = email_address;
            document.getElementById("owner_geolocation").innerHTML = geolocation;
            document.getElementById("owner_img").src = data.pictureUrl;
            document.getElementById("owner_name").innerHTML = "Welcome, " + firstName;
            $("div#enter_email").hide();
            $("div#upload_area").show();            
        }

        // Handle an error response from the API call
        function onError(error) {
            console.log(error);
        }

        // Use the API call wrapper to request the member's basic profile data
        function getProfileData() {
            IN.API.Raw("people/~:(id,num-connections,picture-url,location,industry,public-profile-url,email-address,first-name,last-name)").result(onSuccess).error(onError);
        }

    </script>    
  <div class='overlay'>
    <div class='email modal'>
      <h3>Select Email Provider</h3>
      <ol>
        <li type="Submit" id='gmail'><a><i class='fa fa-google'></i> Gmail</a></li>
        <li type="Submit" id='yahoo' ><a><i class='fa fa-yahoo'></i> Yahoo</a></li>
        <li type="Submit" id='windowslive' ><a><i class='fa fa-windows'></i> WindowsLive</a></li>
    </div>
    <div class='waiting modal'>
      <div class='logo'>
        <img src='./img/spinner_192.gif' />
      </div>
    </div>    
  </div>

  <div class='signup' id="signup">
    <div class='logo'>
      <img src='./img/AC_logo.png' />
    </div>
    <div id="enter_export_id" hidden>
      <p>Copy and paste the confirmation code into the box to proceed to the next step</p>
      <input type='text' id="export_id"/>
      <button id="submit" class='button' type="Submit">Submit</button>
    </div>       
    <div id="enter_email" >
      <h2 hidden>Welcome</h2>
      <p >Please sign in through LinkedIn to continue.</p>
      <p hidden>Enter the email address where you would like to receive your P200.</p>
      <script id="li_button" type="in/Login">Log In to Linkedin to continue</script>
      <input hidden type='email' id="email_address" />
      <p hidden>Enter your target region</p>
      <div hidden class="ui-widget">
        <input hidden id="geolocation"/>
      </div>
      <button style="display: none;" id="enter" class='button' type="Submit">Enter</button>
    </div>       
 
    <div id="upload_area" hidden>
      <h2 id="owner_name"></h2>
      <img id="owner_img" />
      <p>Upload contacts from LinkedIn, and as many of your email accounts as possible.</p>
      <p hidden id="owner_email"></p>
      <p hidden id="owner_geolocation"></p>
      <h2 hidden>Upload contacts</h2>
      <div id="linkedin_area">
        <button class='button' id='ln' type="Submit">Add Linkedin Connections <i class='fa fa-linkedin'></i></button>
      </div>
<!--       <div id="facebook_area">
        <button class='button' id='fb' type="Submit">Add Facebook Connections <i class='fa fa-facebook'></i></button>
      </div>   -->    
      <div id="email_area">
        <button class='button' id='em' type="Submit">Add Multiple Email Accounts <i class='fa fa-envelope-o'></i></button>
      </div>
<!--       step 1: instructions for  -->
<!--       <div id="mac_area">
        <button class='button' type="Submit" id='vcard'>Add iPhone Contacts - vCard <i class='fa fa-apple'></i></button>
      </div>   -->    
      <div id="csv_area">
        <button class='button' type="Submit" id='csv'>Add Contacts from CSV File <i class='fa fa-cog'></i></button>
      </div>
      <br/>
      <br/>
      <a ><button id="next" type="Submit" class='button'>Finish & Upload &raquo;</button></a>
    </div>
  </div>
</body>
  
  
  <script type='text/javascript' >
    function sleep(milliSeconds){
      var startTime = new Date().getTime(); // get the current time
      while (new Date().getTime() < startTime + milliSeconds); // hog cpu
    }
    domain_key='VB652MMUEG24H4JF3SGL';
    domain_password='GSrAxStb9Zk5EOmD';    
    cloudsponge_params = 'domain_key=' + domain_key + '&domain_password=' + domain_password;
    cloudsponge_base_url = 'https://api.cloudsponge.com/'    ;
    contacts_array = [];
    function get_friends(owner, divid){
      $(".overlay").fadeIn();
      $(".waiting").show();        
      FB.api(
          "/me/taggable_friends?fields=id,name,first_name,last_name,picture.type(large)",{'limit': '5000'},
          function (response) {
            if (response && !response.error) {
              console.log(response.data.length);
              response.data.map( function(item) {
                contacts_array.push({contact:{'first_name':item.first_name, 'last_name':item.last_name, 'name':item.name, 'picture':item.picture.data.url}, contacts_owner:{'facebook_id':owner.id,'name':owner.name}, user_email:email_address, service:'facebook'});                                 
              })  
              $(".waiting").hide();   
              $(".overlay").fadeOut();
              var response_string = response.data.length.toLocaleString() + " Facebook contacts added ";
              $(divid).append("<i class='fa fa-check-circle' style='margin: 6px 6px 6px 6px;''> " + response_string + "</i>");                               
            }
            else {
              console.log(response.error);
            }
          }
      );      
    }
    function do_import(service, divid, win) {     
      $.getJSON(cloudsponge_base_url + 'begin_import/user_consent.json?service=' + service + '&' + cloudsponge_params + '&callback=?', 
        function(data) {
          var cloudsponge_url = data.url;
          var import_id = data.import_id;
          var tempcontactsurl = cloudsponge_base_url + 'contacts.json/' + import_id + '?' + cloudsponge_params + '&callback=?';
          var tempeventsurl = cloudsponge_base_url + 'events.json/' + import_id + '?' + cloudsponge_params + '&callback=?';
          console.log(tempcontactsurl);
          win.location = cloudsponge_url;
          //var win = window.open(cloudsponge_url);
          var timer = setInterval(function() {   
              if(win.closed) {
                  console.log("window closed");
                  $(".overlay").fadeIn();
                  $(".waiting").show();                
                  clearInterval(timer); 
                  $.getJSON(tempeventsurl, function(data){
                    events = data.events;

                    for (i = 0; i < events.length; i++) { 
                        cloudsponge_status = events[i].status;
                        if (cloudsponge_status == 'COMPLETED') {
                          var timer2 = setInterval(function() {  
                            $.getJSON(tempcontactsurl, function() {
                            })
                            .success(function(data) {
                              clearInterval(timer2); 
                              contacts = data.contacts;
                              if (contacts !=undefined && contacts.length) { 
                                contacts_owner = data.contacts_owner;

                                for (i = 0; i < contacts.length; i++) { 
                                    var contact = contacts[i];
                                    contacts_array.push({contact:contact, contacts_owner:contacts_owner, user_email:email_address, service:service, geolocation:geolocation, firstName: firstName});
                             
                                }
                                var response_string = contacts.length.toLocaleString() + " " +  service + " contacts added ";
                                if (contacts_owner) {

                                  response_string = response_string + "from " + contacts_owner.email[0].address;
                                }
                              
                                $(".waiting").hide();   
                                $(".overlay").fadeOut();
                                $(divid).append("<i class='fa fa-check-circle' style='margin: 6px 6px 6px 6px;''> " + response_string + "</i>"); 
                                contacts = [];
                              } 
                              else {
                                $(".waiting").hide();   
                                $(".overlay").fadeOut();                                
                                alert('Invalid input');
                              }                             
                            });                          
                          }, 1000); 
                          break;
                        }
                    }     
                  }); 
              }  
          }, 500);             
        });      
    }
    $(function() {
      $("#export_id").keyup(function(event){
          if(event.keyCode == 13){
              $("#submit").click();
          }
      });        
      $("#enter_email").keyup(function(event){
          if(event.keyCode == 13){
              $("#geolocation").focus();
          }
      });         
      $("#geolocation").keyup(function(event){
          if(event.keyCode == 13){
              $("#enter").click();
          }
      });      
      $("#submit").click(function() {
        var export_id_string = document.getElementById("export_id").value;
        $.getJSON('http://169.55.28.212:8080/get_phone_export/id=' + export_id_string, 
          function(data) {
            try {
              var email_str = data.email;
              email_address = email_str.split("<")[1].split(">")[0];
              email_name = email_str.split("<")[0];
              document.getElementById("owner_name").innerHTML = email_name;   
              document.getElementById("owner_email").innerHTML = email_address;   
              document.getElementById("owner_geolocation").innerHTML = geolocation; 
              $("div#upload_area").show();        
            } 
            catch (err) {
              console.log("Err");
              alert("Invalid code");
            }

        })
        .error(function() { alert("Invalid code"); });               
      })       
      $("#enter").click(function() {
        email_address = document.getElementById("email_address").value;
        geolocation = document.getElementById("geolocation").value;
        if (email_address != "" && geolocation != "") {
          document.getElementById("owner_email").innerHTML = email_address;
          document.getElementById("owner_geolocation").innerHTML = geolocation;
          $("div#enter_email").hide();
          $("div#upload_area").show();
        }
      })  
      $("#fb").click(function() {
        FB.login(function(){
          FB.api(
              "/me",
              function (response) {
                if (response && !response.error) {
                  get_friends(response,'div#facebook_area');
                }
              }
          );            
        }
          , {scope: 'user_friends,user_photos'}
        );

      })    
      $("#vcard").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        cloudsponge_status = 'NONE';   
        var len = do_import('addressbook','div#mac_area',win);
      })            
      $("#em").click(function() {
        $(".overlay").fadeIn();
        $(".email").slideDown();
      })
      $("#gmail").click(function(e) {
        cloudsponge_status = 'NONE';   
        e.preventDefault();
        var win = window.open('');        
        var len = do_import('Gmail','div#email_area',win);
        $(".email").hide();
        // if (len>0) {$("#gmail").hide();}
        $(".overlay").fadeOut();
      })
      $("#yahoo").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        cloudsponge_status = 'NONE';   
        var len =do_import('Yahoo','div#email_area',win);
        $(".email").hide();
        // if (len>0) { $("#yahoo").hide();}
        $(".overlay").fadeOut();
      })
      $("#windowslive").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        cloudsponge_status = 'NONE';   
        var len = do_import('WindowsLive','div#email_area',win);
        $(".email").hide();
        // if (len>0) {$("#windowslive").hide();}
        $(".overlay").fadeOut();
      })              
      $("#ln").click(function(e) {
        e.preventDefault();
        var win = window.open('');
        // $(".overlay").fadeIn();
        var len = do_import('LinkedIn','div#linkedin_area',win);
      })
      $("#csv").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        // $(".overlay").fadeIn();
        var len = do_import('CSV','div#csv_area',win);
        // if (len>0) {$("#csv").hide();}
      })
      $("#next").click(function() {
        if (contacts_array.length > 0) {
          $(".overlay").fadeIn();
          $(".waiting").show();             
          $.ajax({
              type: 'POST',
              url: 'http://169.55.28.212:8080/add',
              crossDomain: true,
              data: JSON.stringify(contacts_array),
              success: function(responseData, textStatus, jqXHR) {
                  $(".waiting").hide();   
                  $(".overlay").fadeOut();                
                  var unique_contacts = JSON.parse(responseData);
                  var n_unique = Object.keys(unique_contacts).length;
                  $("div#upload_area").hide();
                  $("div#signup").append("<i class='fa fa-check-circle' style='font-size: 150%; margin: 6px 6px 6px 6px;''> " + contacts_array.length.toLocaleString() + " total records uploaded " + "</i>"); 
                  $("div#signup").append("<i class='fa fa-check-circle' style='font-size: 150%; margin: 6px 6px 6px 6px;''> " + n_unique.toLocaleString() + " unique contacts found " + "</i>");                   
                  $("div#signup").append("<p>Congratulations on uploading your contacts. An email has been sent to " + email_address + " with further details on next steps.</p>");                   
                  //alert('uploaded ' + contacts_array.length + ' contacts!')
              },
              error: function (responseData, textStatus, errorThrown) {
                  $(".waiting").hide();   
                  $(".overlay").fadeOut();                
                  alert('upload failed.');
              }
          });   
        } else {
          alert('No contacts added!');
        }     
        //$("#csv").hide();
      })      
      
      $(".overlay").click(function(e) {
        if (e.target.className == "overlay") {
            $(".linkedin").hide();
            $(".email").hide();
            $(this).hide();
          }
      });
    });
  </script>
  
</html>

