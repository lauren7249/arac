{% extends 'base.html' %}
{% block content %}    
  <input name=_csrf_token type=hidden value="{{ csrf_token() }}">
  <script type="text/javascript">
    var domain_key='VB652MMUEG24H4JF3SGL';
    var domain_password='GSrAxStb9Zk5EOmD';    
    var cloudsponge_params = 'domain_key=' + domain_key + '&domain_password=' + domain_password;
    var cloudsponge_base_url = 'https://api.cloudsponge.com/'    ;
    var cloudsponge_status = '';
    var downloadWindow = null;
    var public_url = null;

    // Handle an error response from the API call
    function onError(error) {
        console.log(error);
    }

    $( document ).ready(function() {
      var ua = navigator.userAgent.toLowerCase();
     
      console.log(ua);
      if (/chrome/.test(ua)) {
        
      }
      else if (!/opera/.test(ua) && /msie/.test(ua)) {

      } 
      else if ("{{ newWindow }}" == 'true') {

      }
      if ("{{ status }}" == 'all_done') {
        $("#step-1").hide();
        attemptFinish();             
      }
      else if ({{ agent.unique_contacts_uploaded | int }} > 0 && "{{ status }}" != "in_progress") {
        var message = "Welcome back! You've uploaded {{ '{0:,}'.format(agent.unique_contacts_uploaded | int) }} unique contacts so far, and it's not too late to add more. You don't need to re-connect any accounts you've already connected, but it's OK if you do. We're keeping track of everything for you." ;
        showSuccess(message);
        console.log(message);
      }
      
    });    

  </script>

  <div class="wrap section onboarding" id="mainDiv">
      <!-- Onboard Step 1-->
    <div class="onboard" id="step-1">
      <div class="wizard">
        <ol>
          <li >
            <label>Step One</label>
            <p>Connect Your Accounts</p>
          </li>        
          <li class="idle">
            <label>Step Two</label>
            <p>Finish</p>
          </li>
        </ol>
      </div>
      <div class="onboard-body">
        <div class="wrap">
          <div class="col-6">
            <div class="note">
              <h2>Welcome to AdvisorConnect!</h2>
              <p>Let's get started by connecting your accounts.</p>
              <p>Select your account from the right and then follow the instructions.</p>
              <p>You can repeat this step until you have chosen all of your accounts. </p>
              <small>Don't worry, none of your personal messages or your contacts’ personal information will be shared with {{ inviter }}.</small>
            </div>
          </div>
          <div class="col-6">
            <div id='linkedin-area' class="connect-email">
              <img id='linkedin' type="Submit" src="/static/img/linkedin-40.png"/>
              <div class="hint--top hint--big button teal small" data-hint="Click here to sign in to LinkedIn and add contacts from your profile.">Add LinkedIn Account</div>           
              <div class='connected_area'>
                {%if agent.contacts_from_linkedin | int > 0 %}
                  <div class='connected' id="linkedin_response">Added {{ '{0:,}'.format(agent.contacts_from_linkedin | int) }} contacts from LinkedIn</div>
                {%endif%}             
              </div>                  
            </div>            
            <div id='gmail-area' class="connect-email">
              <img id='gmail' type="Submit" src="/static/img/gmail-40.png"/>
              <div class="hint--top hint--big button teal small" data-hint="Click here to sign in to Gmail and add contacts from your email accounts. You can connect more than one Gmail account by clicking this button more than once.">Add Gmail Account</div>
              <div class='connected_area'>
                {%if agent.contacts_from_gmail | int > 0 %}
                  <div class='connected' id="gmail_response">Added {{ '{0:,}'.format(agent.contacts_from_gmail | int) }} contacts from Gmail</div>
                {%endif%}                  
              </div>                  
            </div>
            <div id='yahoo-area' class="connect-email">
              <img id='yahoo' type="Submit" src="/static/img/yahoo-mail-40.png"/>
              <div class="hint--top hint--big button teal small" data-hint="Click here to sign in to Yahoo and add contacts from your email accounts. You can connect more than one Yahoo account by clicking this button more than once.">Add Yahoo! Account</div>
              <div class='connected_area'>
                {%if agent.contacts_from_yahoo | int > 0 %}
                  <div class='connected' id="yahoo_response">Added {{ '{0:,}'.format(agent.contacts_from_yahoo | int) }} contacts from Yahoo</div>
                {%endif%}                 
              </div>
            </div>
            <div id='windowslive-area' class="connect-email">
              <img id='windowslive' type="Submit" src="/static/img/windows-live-40.png"/>
              <div class="hint--top hint--big button teal small" data-hint="Click here to sign in to WindowsLive and add contacts from your email accounts. You can connect more than one account from WindowsLive by clicking this button more than once.">Add Windows Live (Hotmail, Outlook) Account</div>
              <div class='connected_area'>
                {%if agent.contacts_from_windowslive | int > 0 %}
                  <div class='connected' id="windowslive_response">Added {{ '{0:,}'.format(agent.contacts_from_windowslive | int) }} contacts from Windows Live</div>
                {%endif%}                  
              </div>
            </div>
            <div id='aol-area' class="connect-email">
              <img id='aol'  type="Submit" src="/static/img/aol-40.png"/>
              <div class="hint--top hint--big button teal small" data-hint="Click here to sign in to AOL and add contacts from your email accounts. You can connect more than one account from AOL by clicking this button more than once.">Add AOL Account</div>
              <div class='connected_area'>
                {%if agent.contacts_from_aol | int > 0 %}
                  <div class='connected' id="aol_response">Added {{ '{0:,}'.format(agent.contacts_from_aol | int) }} contacts from AOL</div>
                {%endif%}                  
              </div>
            </div>              
          </div>
        </div>
      </div>
      <div class="onboard-footer"><small>
        <button id="hack_next" onclick="attemptFinish();" style='border:0;' class="button dark-blue">Next</button>  
      </div>     
    </div>       
    <div class="wrap">

      <div class="onboard" id="step-2">
        <div class="wizard">
          <ol>
            <li class="complete">
              <label>Step One</label>
              <p>Connect Your Email Accounts</p>
            </li>        
            <li >
              <label>Step Two</label>
              <p>Finish</p>
            </li>
          </ol>
        </div>
        <div class="onboard-body">
          <div class="wrap">            
            <div class="note text-center">
              <h1>Congratulations!</h1>
              <h3 class="text-teal">You’ve successfully uploaded a total of <span class='final-contact-count'></span> Contacts!</h3>
              <p>We will email you when your Network Summary is complete.</p>
              <div class='center'><a href='/auth/logout'><button class='button teal'>Close</button></a></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script type='text/javascript' >

    var cloudsponge_base_url = 'https://api.cloudsponge.com/'    ;
    function do_import(service, divid, win) {     
      if(service == 'LinkedIn') {
          win.location.href = '/linkedin_login';
          $("#spinner").fadeIn();
          var timer = setInterval(function() {   
            if(win.closed) {
              clearInterval(timer);   
              window.location.href = '/?status=in_progress';
              $("#spinner").fadeOut();       
            }  
          }, 500);  
      } 
      else {
        var url = cloudsponge_base_url + 'begin_import/user_consent.json';
        $.getJSON(url + '?service=' + service + '&' + cloudsponge_params + '&callback=?', 
        function(data) {
          var cloudsponge_url = data.url;
          var import_id = data.import_id;
          var tempcontactsurl = cloudsponge_base_url + 'contacts.json/' + import_id + '?' + cloudsponge_params + '&callback=?';
          var tempeventsurl = cloudsponge_base_url + 'events.json/' + import_id + '?' + cloudsponge_params + '&callback=?';
          console.log(tempcontactsurl);

          win.location.href = cloudsponge_url;
          var timer = setInterval(function() {   
            if(win.closed) {
              clearInterval(timer);              
              handle_cloudsponge(tempcontactsurl, tempeventsurl, divid, service);

            }  
          }, 500);              

           
        });      
      }
    }

    function handle_cloudsponge(tempcontactsurl, tempeventsurl, divid, service) {
      console.log(tempeventsurl);
      $.getJSON(tempeventsurl, function(data){
        events = data.events;

        for (i = 0; i < events.length; i++) { 
          cloudsponge_status = events[i].status;
          console.log(cloudsponge_status);
          if (cloudsponge_status == 'COMPLETED') {
            $("#spinner").fadeIn();
            var timer2 = setInterval(function() {  
              $.getJSON(tempcontactsurl, function() {
              })
              .success(function(data) {
                clearInterval(timer2); 
                contacts = data.contacts;
                if (contacts !=undefined && contacts.length) { 
                  var contacts_array = [];
                  contacts_owner = data.contacts_owner;
                  response_element_id = contacts_owner.email[0].address + "_response";

                  status_field = document.getElementById(response_element_id);
                  if (status_field == null || status_field == undefined) {
                    for (i = 0; i < contacts.length; i++) { 
                        var contact = contacts[i];
                        contacts_array.push({contact:contact, contacts_owner:contacts_owner, service:service});
                 
                    }
                    
                    var csrf_token = $("[_csrf_token]").val()

                    var outData = {csrf_token:csrf_token, contacts_array: contacts_array}
                    $.ajax({
                        type: 'POST',
                        url: '/upload_cloudsponge?service=' + service,
                        crossDomain: true,
                        data: JSON.stringify(outData),
                        dataType: 'json',
                        contentType: 'application/json; charset=utf-8',
                        success: function(responseData, textStatus, jqXHR) {
                          //location.reload(true);
                          //window.location.assign('/?status=in_progress');
                          window.location.href = '/?status=in_progress';
                          $("#spinner").fadeOut();
                          return true;
                        },
                        error: function (responseData, textStatus, errorThrown) {
                            $("#spinner").fadeOut();                
                            showSuccess("It appears there was an issue with the upload. An error report has been sent. We apologize for the inconvenience.");
                        }
                    }); 
                  }
                  else {  
                    $("#spinner").fadeOut();     
                    return true;                               
                  }
                  contacts = [];
                  return true;
                } 
                else {
                  $("#spinner").fadeOut();                                
                  return true;
                }                             
              });                          
            }, 1000); 
            break;
          } 
          else if (cloudsponge_status =="ERROR") {
            $("#spinner").fadeOut();     
            break;    
            return true;                   
          }
        }   
      });       
    }

    function attemptFinish() {
      if ({{ current_user.unique_contacts_uploaded | int }} >0) {
        upload()
      } else {
        var message = "You haven't added any contacts yet, but you can always come back later to complete your signup.";
        showSuccess(message);
      }      
    }
  
    $(function() {
      bindEmailButtons();
    });

    function upload() {
        $("#spinner").fadeIn();  
        var csrf_token = $("[_csrf_token]").val() 
        var outData = {csrf_token:csrf_token, contacts_array: []}
        $.ajax({
            type: 'POST',
            url: '/upload_cloudsponge?complete=yes',
            crossDomain: true,
            data: JSON.stringify(outData),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function(responseData, textStatus, jqXHR) {
              $("#next").hide()
              $(".final-contact-count").html("{{ '{0:,}'.format(current_user.unique_contacts_uploaded | int) }}")
              $("#step-1").hide(); 
              $("#step-2").slideDown()   
              $("#spinner").fadeOut();   
              console.log(responseData);
            },
            error: function (responseData, textStatus, errorThrown) {
                $("#spinner").fadeOut();                
                showSuccess("It appears there was an issue with the upload. An error report has been sent. We apologize for the inconvenience.");
            }
        });  
    }
   
    function bindEmailButtons() {

      $("#linkedin-area").click(function(e) {
        cloudsponge_status = 'NONE';   
        e.preventDefault();
        var win = window.open('');        
        var len = do_import('LinkedIn','#linkedin-area',win);
        $(".linkedin").hide();
        $("#spinner").fadeOut();
      });

      $("#gmail-area").click(function(e) {
        cloudsponge_status = 'NONE';   
        e.preventDefault();
        var win = window.open('');        
        var len = do_import('Gmail','#gmail-area',win);
        $(".email").hide();
        $("#spinner").fadeOut();
      });

      $("#yahoo-area").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        cloudsponge_status = 'NONE';   
        var len =do_import('Yahoo','#yahoo-area',win);
        $(".email").hide();
        $("#spinner").fadeOut();
      });

      $("#windowslive-area").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        cloudsponge_status = 'NONE';   
        var len = do_import('WindowsLive','#windowslive-area',win);
        $(".email").hide();
        $("#spinner").fadeOut();
      });

      $("#aol-area").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        cloudsponge_status = 'NONE';   
        var len = do_import('aol','#aol-area',win);
        $(".email").hide();
        $("#spinner").fadeOut();
      });   

    }  

  </script>  

{% endblock %}
