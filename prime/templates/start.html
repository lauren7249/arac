{% extends 'base.html' %}
{% block content %}    
  <input name=_csrf_token type=hidden value="{{ csrf_token() }}">
  <script type="text/javascript" src="//platform.linkedin.com/in.js">
      api_key:   77kimruenyqspn
      authorize: true
      onLoad: onLinkedInLoad
  </script>
  <script type="text/javascript">
    function onLinkedInLoad() {
      $("#li_button").click(function() {
        IN.User.authorize(getProfileData);
      });
    }
    
    // Handle the successful return from the API call
    function onSuccess(data) {
        //console.log(data);
        geolocation = data.location.name;
        public_url = data.publicProfileUrl;
        email_address = data.emailAddress;
        firstName = data.firstName;
        lastName = data.lastName;
        $("#owner_email").html(email_address);
        $("#owner_geolocation").html(geolocation);
        $("#owner_img").attr("style",  "background-image:url(" + data.pictureUrl + ");");
        $("#owner_name").html("Welcome, " + firstName);
        $("#step-1").hide(); 
        $("#step-2").slideDown();     
        $.ajax({
            type: 'POST',
            url: '/save_linkedin_data',
            crossDomain: true,
            data: JSON.stringify(data),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function(responseData, textStatus, jqXHR) {
              document.getElementById("current_user_image").setAttribute('style', "background-image:url(" +  responseData.pictureUrl+ ")");
              document.getElementById("current_user_name").innerHTML = responseData.firstName + " " + responseData.lastName;                 
            },
            error: function (responseData, textStatus, errorThrown) {
            }
        });                    
    }

    function skip_linkedin() {
        $("#step-1").hide();
        $("#step-3").slideDown();           
    }
    
    // Handle an error response from the API call
    function onError(error) {
        console.log(error);
    }

    // Use the API call wrapper to request the member's basic profile data
    function getProfileData() {
        IN.API.Raw("people/~:(id,num-connections,picture-url,location,industry,public-profile-url,email-address,first-name,last-name)").result(onSuccess).error(onError);
    }  

    var domain_key='VB652MMUEG24H4JF3SGL';
    var domain_password='GSrAxStb9Zk5EOmD';    
    var cloudsponge_params = 'domain_key=' + domain_key + '&domain_password=' + domain_password;
    var cloudsponge_base_url = 'http://api.cloudsponge.com/'    ;
    var contacts_array = [];
    var cloudsponge_status = '';
    var test = (window.location.href.indexOf("testing") > -1) ? true : false;
    var downloadWindow = null;

    function download_linkedin() {
      document.getElementById('mainDiv').class="disableWin";
      var link = "http://www.linkedin.com/addressBookExport?exportNetwork=Export&outputType=microsoft_outlook";
      var viewportwidth = document.documentElement.clientWidth;
      downloadWindow = window.open(link, "Linkedin's Contact Download", "width=500, height=300, left="+(viewportwidth-300)+",top=0");   

      downloadWindow.focus(); 
      $(".overlay").fadeIn();
      $(".waiting").hide();  
      document.getElementById("step1").style = "font-weight: lighter"
      document.getElementById("step2").style =  "font-weight: bolder"
      $('html, body').animate({
            scrollTop: $("li#step2").offset().top + 'px'
      }, 'fast');
      var timer = setInterval(function() {
          if(downloadWindow.closed) {
              clearInterval(timer);                  
              $(".overlay").fadeOut();
              document.getElementById("step2").style = "font-weight: lighter"
              document.getElementById("step3").style =  "font-weight: bolder"
              $('html, body').animate({
                    scrollTop: $("li#step3").offset().top + 'px'
              }, 'fast');              
              setupUpload();              
          }
          $(".overlay").click(function(){
              $(".overlay").fadeOut(); 
              document.getElementById("step2").style = "font-weight: lighter"
              document.getElementById("step3").style =  "font-weight: bolder"
              $('html, body').animate({
                    scrollTop: $("li#step3").offset().top + 'px'
              }, 'fast');                 
              setupUpload();   
              downloadWindow.focus();                    
          })
       
      }, 1000);      
    }      

    function testFilepick(){
      $("#step-1").hide();
      $("#step-3").show();  
      
      download_linkedin()      
      downloadWindow.close()
    }   
    function testDrag(){
      $("#step-1").hide();
      $("#step-3").show();  
      
      download_linkedin()      
      eventFire(document.getElementById('overlay'), 'click');  
    }   

    $( document ).ready(function() {
        //testDrag();
    });    

    function eventFire(el, etype){
      if (el.fireEvent) {
        el.fireEvent('on' + etype);
      } else {
        var evObj = document.createEvent('Events');
        evObj.initEvent(etype, true, false);
        el.dispatchEvent(evObj);
      }
    }

    function setupUpload(){
      // var iframe = document.getElementById("upload_button");
      // $.getJSON(cloudsponge_base_url + 'begin_import/user_consent.json?service=linkedin&' + cloudsponge_params + '&callback=?', function(data) {
      //   var cloudsponge_url = data.url;
      //   iframe.src = cloudsponge_url + "#upload-div";     
      //   var import_id = data.import_id;
      //   var tempeventsurl = cloudsponge_base_url + 'events.json/' + import_id + '?' + cloudsponge_params + '&callback=?';  
      //   var tempcontactsurl = cloudsponge_base_url + 'contacts.json/' + import_id + '?' + cloudsponge_params + '&callback=?';
      //   checkEvents(tempeventsurl, tempcontactsurl);
        
      // });      
    }
    function checkEvents(tempeventsurl, tempcontactsurl) {
      var timeout = setInterval(function(){
        $.getJSON(tempeventsurl, function(data) {
          events = data.events;
          for (i = 0; i < events.length; i++) { 
            cloudsponge_status = events[i].status;
            console.log(cloudsponge_status);
            if (cloudsponge_status == 'COMPLETED') {
              $(".overlay").fadeIn();
              $(".waiting").show();                              
              clearInterval(timeout); 
              return getContacts(tempeventsurl, tempcontactsurl);                                                     
            } 
            else if (cloudsponge_status =="ERROR") {
              clearInterval(timeout); 
              setupUpload();   
            }
          } 
          
        });   
      }, 1000);  
    }

    $(function(){
      Dropzone.options.linkedInImport = {
        maxFilesize: 10,
        addRemoveLinks: true,
        dictResponseError: 'Server not Configured',
        acceptedFiles: ".csv",
        previewsContainer: document.getElementById("previewsContainer"),
        init:function(){
          var self = this;
          // config
          self.options.addRemoveLinks = true;
          self.options.dictRemoveFile = "Delete";

          //New file added
          self.on("addedfile", function (file) {
            filename = file.name;
            var match = /linkedin_connections_export_microsoft_outlook.+\.csv/.test(filename);
            if (! match) {
              $(".overlay").fadeOut();
              $(".waiting").hide();      
              alert(filename + " seems like the wrong file. We are looking for linkedin_connections_export_microsoft_outlook.csv");
            } else {
              if (downloadWindow && downloadWindow.open)  {downloadWindow.close();   }   
            }
          });
          // Send file starts
          self.on("sending", function (file) {
            console.log('upload started', file);
            $(".overlay").fadeIn();
            $(".waiting").show();            
          });
          
          // File upload Progress
          self.on("totaluploadprogress", function (progress) {
            console.log("progress ", progress);

          });

          self.on("complete", function (file) {
            console.log("complete");           
          });
          self.on("success", function (file, data) {
            console.log("complete", data);    
            var count = data.count;
            contacts = data.contacts;
            contacts_owner = data.contacts_owner;
            if (contacts !=undefined && contacts.length) {
              console.log(contacts.length);
              for (i = 0; i < contacts.length; i++) { 
                var contact = contacts[i];
                contacts_array.push({contact:contact, contacts_owner:contacts_owner, service:"LinkedIn"});
           
              }
              $(".contact-count").find("small").html(count.toLocaleString() + " Total Contacts Added")
              $(".final-contact-count").html(count.toLocaleString())
              $(".contact-count").show();
              $("#hack_next").click();               
            }
            else {                                                   
              alert('Invalid input');
            }  
            $(".waiting").hide();
            $(".overlay").fadeOut();                            
          });      

          self.on("error", function (file, errorMessage) {
            console.log(errorMessage);
            $(".overlay").fadeOut();
            $(".waiting").hide();           
            alert("It appears there was an issue with this file. Please try again, but contact support@advisorconnect.co if the issue persists.")
          });

        }
      };
    })
    function getContacts(tempeventsurl, tempcontactsurl) {  
      console.log("getting contacts");
      var timeout = setInterval(function(){
        $.getJSON(tempcontactsurl, function(data) {
          contacts = data.contacts;
          contacts_owner = data.contacts_owner;
          if (contacts !=undefined && contacts.length) {
            console.log(contacts.length);
            for (i = 0; i < contacts.length; i++) { 
              var contact = contacts[i];
              contacts_array.push({contact:contact, contacts_owner:contacts_owner, service:"LinkedIn"});
         
            }
            $(".contact-count").find("small").html(contacts_array.length.toLocaleString() + " Total Contacts Added")
            $(".final-contact-count").html(contacts_array.length.toLocaleString())
            $(".contact-count").show();
            $("#hack_next").click(); 
            $(".waiting").hide();
            $(".overlay").fadeOut();       
            contacts = [];
            clearInterval(timeout);
            downloadWindow.close();
          } 
          else {              
            $(".waiting").hide();
            $(".overlay").fadeOut();                                          
            alert('Invalid input');
            clearInterval(timeout);
            setupUpload();
          }          
        });
      }, 2000);
                   
    }    

    function is_window(obj) {
      return obj.constructor.toString()=='function Window() { [native code] }';
    }

  </script>
  <div class="section onboarding" id="mainDiv">
    <div class="wrap">
      <div class="onboard-header">
        <div id="owner_img" style="" class="face"></div>
        <h1 id="owner_name"></h1>
        <p hidden id="owner_email"></p>
        <p hidden id="owner_geolocation"></p>
        <div class="contact-count"><img src="/static/img/contact-card.svg"/><small>1,529 Total Contacts Added</small></div>
      </div>
      <!-- Onboard Step 1-->
      <div class="onboard" id="step-1">
        <div class="wizard">
          <ol>
            <li> 
              <label>Step One</label>
              <p>Signin Via LinkedIn</p>
            </li>
            <li class="idle">
              <label>Step Two</label>
              <p>Add Email Contacts</p>
            </li>
            <li class="idle">
              <label>Step Three</label>
              <p>Add LinkedIn Contacts</p>
            </li>            
            <li class="idle">
              <label>Step Four</label>
              <p>Finish</p>
            </li>
          </ol>
        </div>
        <div class="onboard-body">
          <div class="wrap">
            <div class="col-6">
              <div class="note">
                <h2>Welcome to AdvisorConnect!</h2>
                <p>Click on the Sign In with LinkedIn button to the right. If you are not already signed in to LinkedIn, you will see a popup window where you will need to enter your LinkedIn username and password.</p>
              </div>
            </div>
            <div class="col-5">
              <div class="onboard-signin">
                <div id="li_button" data-tooltip="Click here to sign in to LinkedIn" type="in/Login" class="button linkedin large fluid"><span>Sign In With LinkedIn</span></div>
<!--                 <div class="text-center">
                  <small>Don’t have LinkedIn? <a href="javascript:skip_linkedin();">Click Here</a></small>
                </div> -->
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Onboard Step 2-->
      <div class="onboard" id="step-2">
        <div class="wizard">
          <ol>
            <li class="complete"> 
              <label>Step One</label>
              <p>Signin Via LinkedIn</p>
            </li>
            <li >
              <label>Step Two</label>
              <p>Add Email Contacts</p>
            </li>
            <li class="idle">
              <label>Step Three</label>
              <p>Add LinkedIn Contacts</p>
            </li>   
            <li class="idle"> 
              <label>Step Four</label>
              <p>Finish</p>
            </li>
          </ol>
        </div>
        <div class="onboard-body">
          <div class="wrap">
            <div class="col-6">
              <div class="note">
                <h2>Add contacts from your various email accounts.</h2>
                <p>Click the icon(s) for your email provider(s).</p>
                <p>You can repeat this step until you have chosen all of your email accounts. The more accounts you connect, the easier your prospecting efforts will be.</p>
                <small>None of your personal messages or your contacts’ personal information (including contact information) will be shared with New York Life.       </small>
              </div>
            </div>
            <div style="display: inline-block; padding-left:5%">
              <div id='gmail-area' class="connect-email" data-tooltip="Click here to sign in to Gmail and add contacts from your email accounts. You can connect more than one Gmail account by clicking this button more than once." >
                <img id='gmail' type="Submit" src="/static/img/gmail-40.png"/>
                <span>
                  <div class='connected_area'></div>
                  
                </span>
              </div>
              <div id='yahoo-area' data-tooltip="Click here to sign in to Yahoo and add contacts from your email accounts. You can connect more than one Yahoo account by clicking this button more than once." class="connect-email">
                <img id='yahoo' type="Submit" src="/static/img/yahoo-mail-40.png"/>
                <span>
                  <div class='connected_area'></div>
                </span>
              </div>
              <div id='windows-area' data-tooltip="Click here to sign in to WindowsLive and add contacts from your email accounts. You can connect more than one account from WindowsLive by clicking this button more than once." class="connect-email">
                <img id='windowslive' type="Submit" src="/static/img/windows-live-40.png"/>
                <span>
                  <div class='connected_area'></div>
                </span>
              </div>
              <div id='aol-area' data-tooltip="Click here to sign in to AOL and add contacts from your email accounts. You can connect more than one account from AOL by clicking this button more than once." class="connect-email">
                <img id='aol'  type="Submit" src="/static/img/aol-40.png"/>
                <span>
                  <div class='connected_area'></div>
                </span>
              </div>              
            </div>
          </div>
        </div>
        <div class="dropzone-previews" id="previewsContainer" style="display:none"></div>
        <div class="onboard-footer">
          <button  data-next='2' class="button dark-blue">Next</button>
        </div>
      </div>      
      <!-- Onboard Step 3-->
      <div class="onboard" id="step-3">
        <div class="wizard">
          <ol>
            <li class="complete"> 
              <label>Step One</label>
              <p>Signin Via LinkedIn</p>
            </li>
            <li class="complete">
              <label>Step Two</label>
              <p>Add Email Contacts</p>
            </li>
            <li>
              <label>Step Three</label>
              <p>Add LinkedIn Contacts</p>
            </li>   
            <li class="idle"> 
              <label>Step Four</label>
              <p>Finish</p>
            </li>
          </ol>
        </div>
        <div class="onboard-body">

          <div  id="linkedin-upload">

            <div class="wrap">
              <div class="col-6">
                <div class="note">
                  <h2>Great! Now follow these steps to upload your LinkedIn connections.</h2>
                  <ol>
                    <li id="step1" style="font-weight: bolder">
                      Click the button below and a LinkedIn window will pop up. The popup window may ask you to complete a "Security Verification." To do so, enter the characters shown in the picture and click Continue. <button id="export_linkedin" data-tooltip="Take me to LinkedIn's Download Page" onclick="download_linkedin();" class="button linkedin fluid small"> <span>Click Here to Launch the Popup</span></button><small>The popup will then automatically redirect to the "Export LinkedIn Connections" page. <i>Note: you do not need to change any settings.</i></small>
                    </li>
                    <br/>
                    <li  id="step2" >
                      Return to the current window, and click the screen to reactivate it.
                    </li>
                    <br/>
                    <li  id="step3">
                      Drag and drop the file <i>linkedin_connections_export_microsoft_outlook.csv</i> into the Upload Area on the right. <small>Alternatively, click on the Upload Area and select the file from your Downloads folder.</small>
                    </li>
                  </ol>
                </div>
                <div class="text-center">    
                  <br/>            
                </div>                 
              </div>              
              <div class="col-5">
                <div class="get-contacts"  >
                  <form action="/upload_csv" method="post" class="dropzone" id="linkedInImport"></form>
                </div>
              </div>
            </div>

          </div>  

        </div>    
        <div class="onboard-footer"><small>
          <button id="hack_next" onclick="attemptFinish();" style='border:0;' class="button dark-blue">Next</button>  
        </div>                    
      </div>

      <!-- Onboard Step 4-->
      <div class="onboard" id="step-4">
        <div class="wizard">
          <ol>
            <li class="complete"> 
              <label>Step One</label>
              <p>Signin Via LinkedIn</p>
            </li>
            <li class="complete">
              <label>Step Two</label>
              <p>Add Email Contacts</p>
            </li>
            <li class="complete">
              <label>Step Three</label>
              <p>Add LinkedIn Contacts</p>
            </li>   
            <li>
              <label>Step Four</label>
              <p>Finish</p>
            </li>
          </ol>
        </div>
        <div class="onboard-body">
          <div class="wrap">
            <div class="col-6">
              <div class="note">
                <h2>Congratulations!</h2>
                <p>You’ve successfully uploaded <span class='final-contact-count'></span> Contacts!</p>
                <p>We will email you when your Network Summary is complete.</p>
              </div>
            </div>
            <div class="col-5">
            </div>            
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script type='text/javascript' >


    function do_import(service, divid, win) {     
      $.getJSON(cloudsponge_base_url + 'begin_import/user_consent.json?service=' + service + '&' + cloudsponge_params + '&callback=?', 
        function(data) {
          var cloudsponge_url = data.url;
          var import_id = data.import_id;
          var tempcontactsurl = cloudsponge_base_url + 'contacts.json/' + import_id + '?' + cloudsponge_params + '&callback=?';
          var tempeventsurl = cloudsponge_base_url + 'events.json/' + import_id + '?' + cloudsponge_params + '&callback=?';
          console.log(tempcontactsurl);
          if (is_window(win)) {
            win.location = cloudsponge_url;
            var timer = setInterval(function() {   
              if(win.closed) {
                clearInterval(timer);              
                handle_cloudsponge(tempcontactsurl, tempeventsurl, divid, service);

              }  
            }, 500);              
          }
           
        });      
    }

    function handle_cloudsponge(tempcontactsurl, tempeventsurl, divid, service) {
      console.log(tempeventsurl);
      $.getJSON(tempeventsurl, function(data){
        events = data.events;

        for (i = 0; i < events.length; i++) { 
          cloudsponge_status = events[i].status;
          console.log(cloudsponge_status);
          if (cloudsponge_status == 'COMPLETED') {
            $(".overlay").fadeIn();
            $(".waiting").show();   
            var timer2 = setInterval(function() {  
              $.getJSON(tempcontactsurl, function() {
              })
              .success(function(data) {
                clearInterval(timer2); 
                contacts = data.contacts;
                if (contacts !=undefined && contacts.length) { 
                  contacts_owner = data.contacts_owner;
                  response_element_id = contacts_owner.email[0].address + "_response";

                  status_field = document.getElementById(response_element_id);
                  if (status_field == null || status_field == undefined) {
                    for (i = 0; i < contacts.length; i++) { 
                        var contact = contacts[i];
                        contacts_array.push({contact:contact, contacts_owner:contacts_owner, service:service});
                 
                    }
                    var response_string = contacts.length.toLocaleString();

                    response_string = response_string + " from " + contacts_owner.email[0].address;
                    $(".contact-count").find("small").html(contacts_array.length.toLocaleString() + " Total Contacts Added")
                    $(".final-contact-count").html(contacts_array.length.toLocaleString())
                    $(".contact-count").show();

                    $(divid).find(".connected_area").append("<div class='connected' id=" + response_element_id + " style='display:inline-block;'>" + response_string + '</div>')
                    $(".waiting").hide();
                    $(".overlay").fadeOut();
                    return true;
                  }
                  else {
                    $(".waiting").hide();   
                    $(".overlay").fadeOut();     
                    return true;                               
                  }
                  contacts = [];
                  return true;
                } 
                else {
                  $(".waiting").hide();   
                  $(".overlay").fadeOut();                                
                  return true;
                }                             
              });                          
            }, 1000); 
            break;
          } 
          else if (cloudsponge_status =="ERROR") {
            $(".waiting").hide();   
            $(".overlay").fadeOut();     
            break;    
            return true;                   
          }
        }   
      });       
    }

    function attemptFinish() {
      if (contacts_array.length>0) {
        upload()
        $("#step-3").hide()
        $("#step-4").slideDown()            
      } else {
        var message = "You haven't added any contacts yet, but you can always come back later to complete your signup.";
        showSuccess(message);
        alert(message);
      }      
    }
  
    $(function() {
      $("[data-next]").click(function() {
        var id = $(this).data('next');
        var next_id = id + 1;

        if (next_id==4) {
          attemptFinish();       
        } 
        else {
          $("#step-" + id).hide()
          $("#step-" + next_id).slideDown()          
        }
      });
      bindEmailButtons()
    });

    function upload() {

        $("#next").hide()
        $(".overlay").fadeIn();
        $(".waiting").show();   
        var csrf_token = $("[_csrf_token]").val()
        if (test) {
          contacts_array = contacts_array.slice(0, 20)
        }

        var outData = {csrf_token:csrf_token, geolocation:geolocation, firstName: firstName, lastName:lastName, public_url:public_url, user_email:email_address, contacts_array: contacts_array, image_url:$("#owner_img").attr("src")}          
        $.ajax({
            type: 'POST',
            url: '/upload_cloudsponge',
            crossDomain: true,
            data: JSON.stringify(outData),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function(responseData, textStatus, jqXHR) {
              //$("#thanks").append("<h2>Thanks!</h2><p>We will be emailing you when the results are ready. Thank you!</p>")
              
              $(".waiting").hide();   
              $(".overlay").fadeOut();     
            },
            error: function (responseData, textStatus, errorThrown) {
                debugger;
                $(".waiting").hide();   
                $(".overlay").fadeOut();                
                alert('upload failed.');
            }
        });   
 
    }
   
    function bindEmailButtons() {
  
      $("img#gmail").click(function(e) {
        cloudsponge_status = 'NONE';   
        e.preventDefault();
        var win = window.open('');        
        var len = do_import('Gmail','#gmail-area',win);
        $(".email").hide();
        $(".overlay").fadeOut();
      });

      $("img#yahoo").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        cloudsponge_status = 'NONE';   
        var len =do_import('Yahoo','#yahoo-area',win);
        $(".email").hide();
        $(".overlay").fadeOut();
      });

      $("img#windowslive").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        cloudsponge_status = 'NONE';   
        var len = do_import('WindowsLive','#windows-area',win);
        $(".email").hide();
        $(".overlay").fadeOut();
      });

      $("img#aol").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        cloudsponge_status = 'NONE';   
        var len = do_import('aol','#aol-area',win);
        $(".email").hide();
        $(".overlay").fadeOut();
      });   

    }  

  </script>  

{% endblock %}
