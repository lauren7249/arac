{% extends 'base.html' %}
{% block content %}    
    <script type="text/javascript">
        
        // Setup an event listener to make an API call once auth is complete
        function onLinkedInLoad() {
          $("#li_button").click(function() {
            IN.User.authorize(getProfileData);
          });
        }

        // Handle the successful return from the API call
        function onSuccess(data) {
            //console.log(data);
            geolocation = data.location.name;
            public_url = data.publicProfileUrl;
            email_address = data.emailAddress;
            firstName = data.firstName;
            lastName = data.lastName;
            $("#owner_email").html(email_address);
            $("#owner_geolocation").html(geolocation);
            $("#owner_img").attr("style",  "background-image:url(" + data.pictureUrl + ");");
            $("#owner_name").html("Welcome, " + firstName);
            $("#step-1").hide();
            $(".onboard-header").show();
            $("#step-2").slideDown();     
            $.ajax({
                type: 'POST',
                url: '/save_linkedin_data',
                crossDomain: true,
                data: JSON.stringify(data),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function(responseData, textStatus, jqXHR) {
                  document.getElementById("current_user_image").setAttribute('style', "background-image:url(" +  responseData.pictureUrl+ ")");
                  document.getElementById("current_user_name").innerHTML = responseData.firstName + " " + responseData.lastName;
                },
                error: function (responseData, textStatus, errorThrown) {
                }
            });                    
        }

        // Handle an error response from the API call
        function onError(error) {
            console.log(error);
        }

        // Use the API call wrapper to request the member's basic profile data
        function getProfileData() {
            IN.API.Raw("people/~:(id,num-connections,picture-url,location,industry,public-profile-url,email-address,first-name,last-name)").result(onSuccess).error(onError);
        }

    </script>    
    <div class="section onboarding">
      <div class="wrap">
        <div class="onboard-header">
          <div id="owner_img" style="" class="face"></div>
          <h1 id="owner_name"></h1>
          <p hidden id="owner_email"></p>
          <p hidden id="owner_geolocation"></p>
          <div class="contact-count"><img src="https://s3-us-west-2.amazonaws.com/advisorconnect/images/onboarding/contact-card.svg"/><small>1,529 Total Contacts Added</small></div>
        </div>
        <!-- Onboard Step 1-->
        <div class="onboard" id="step-1">
          <div class="wizard">
            <ol>
              <li> 
                <label>Step One</label>
                <p>Signin Via LinkedIn</p>
              </li>
              <li class="idle">
                <label>Step Two</label>
                <p>Add LinkedIn Contacts</p>
              </li>
              <li class="idle">
                <label>Step Three</label>
                <p>Add Email Contacts</p>
              </li>
              <li class="idle">
                <label>Step Four</label>
                <p>Finish & Upload</p>
              </li>
            </ol>
          </div>
          <div class="onboard-body">
            <div class="wrap">
              <div class="col-6">
                <div class="note">
                  <h2>Welcome to AdvisorConnect!</h2>
                  <p>Let’s get started by connecting your LinkedIn profile. This will allow us to include your LinkedIn information in AdvisorConnect.</p>
                </div>
              </div>
              <div class="col-5">
                <div class="onboard-signin">
                  <div id="li_button" type="in/Login" class="button linkedin large fluid"> <i class="icon-linkedin"></i><span>Sign In With LinkedIn</span></div>
                  <div class="text-center"><small>

                      Don’t have LinkedIn? <a href="javascript:alert('This is not currently supported.');">Click Here</a></small></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Onboard Step 2-->
        <div class="onboard" id="step-2">
          <div class="wizard">
            <ol>
              <li class="complete"> 
                <label>Step One</label>
                <p>Signin Via LinkedIn</p>
              </li>
              <li> 
                <label>Step Two</label>
                <p>Add LinkedIn Contacts</p>
              </li>
              <li class="idle"> 
                <label>Step Three</label>
                <p>Add Email Contacts</p>
              </li>
              <li class="idle"> 
                <label>Step Four</label>
                <p>Finish & Upload</p>
              </li>
            </ol>
          </div>
          <div class="onboard-body">
            <div class="wrap">
              <div class="col-6">
                <div class="note">
                  <h2>Now, let's build your network.</h2>
                  <p>1. Click on the "Get LinkedIn Contacts" button.</p><small>This will take you to the linkedin upload form (as seen below)</small><img src="{{ static_url() }}img/cloudsponge.png"/>
                  <hr/>
                  <p>2. Next, click on the "Get Contacts" button.</p><small>This will take you to the LinkedIn Security Verification (as seen below) where you will need to enter the required text and click "Continue".</small><img src="https://s3-us-west-2.amazonaws.com/advisorconnect/images/onboarding/onboard-linkedin-security.png"/>
                  <hr/>
                  <p>3. Then, upload CSV file</p><small>CHROME USERS:</small><small>Drag your contacts file from the bottom left corner of your browser window (as shown below) onto the "upload" box on the linkedin upload form.</small><img src="https://s3-us-west-2.amazonaws.com/advisorconnect/images/onboarding/onboard-linkedin-chrome.png"/><small>OTHER BROWSERS:</small><small>Drag the linkedin csv download from your downloads folder</small>
                  <hr/>
                  <p>4. Close Other Windows</p><small>Close the linkedin page and linkedin upload form and navigate back here.</small>
                </div>
              </div>
              <div class="col-5">
                <div class="get-contacts">
                  <button id='ln' class="button linkedin fluid large"> <i class="icon-linkedin"></i><span>Get LinkedIn Contacts</span></button>
                </div>
                <div class="file-upload">
                  <!--
                  <p class="text-center">Upload your .csv file here</p>
                  <div class="upload-box"><i class="icon-upload"></i>
                    <p>Drag & Drop</p>
                    <p>Your .csv file here or browse</p>
                  </div>
                  <div class="upload-box complete"><i class="icon-upload"></i>
                    <p>Drag & Drop</p>
                    <p>Your .csv file here or browse</p>
                  </div>
                  -->
                </div>
                  <!--
                <div class="upload-instructions">
                  <p>

                  Can't find your LinkedIn contacts file?  <a href="#">Click here </a>and navigate to your Downloads folder and look for a file named <b>"linkedin_connections_export_microsoft_outlook.csv". </b>
                  </p>
                  <p>If you still can't find your file click here to download your contacts again or skip this step.</p>
                </div>
                  -->
              </div>
            </div>
          </div>
          <div class="onboard-footer">
            <button data-next='2' class="button dark-blue">Next</button>
          </div>
        </div>
        <!-- Onboard Step 3-->
        <div class="onboard"  id="step-3">
          <div class="wizard">
            <ol>
              <li class="complete"> 
                <label>Step One</label>
                <p>Signin Via LinkedIn</p>
              </li>
              <li class="complete">
                <label>Step Two</label>
                <p>Add LinkedIn Contacts</p>
              </li>
              <li> 
                <label>Step Three</label>
                <p>Add Email Contacts</p>
              </li>
              <li class="idle"> 
                <label>Step Four</label>
                <p>Finish & Upload</p>
              </li>
            </ol>
          </div>
          <div class="onboard-body">
            <div class="wrap">
              <div class="col-6">
                <div class="note">
                  <h2>Now, let's add your email contacts.</h2>
                  <p>You can add contacts from more than one account.  Remember that the more accounts you connect, the more valuable this tool will be to your marketing and prospecting efforts.</p><small>None of your personal messages or your contacts’ personal information (including contact information) will be shared with New York Life.               </small>
                </div>
              </div>
              <div class="col-5">
                <div id='gmail-area' class="connect-email">
                  <img src="https://s3-us-west-2.amazonaws.com/advisorconnect/images/onboarding/onboard-gmail.png"/>
                  <span>
                    <div class='connected'></div>
                    <button id='gmail' type="Submit" class="button teal">Connect Gmail</button>
                  </span>
                </div>
                <div id='yahoo-area' class="connect-email">
                  <img src="https://s3-us-west-2.amazonaws.com/advisorconnect/images/onboarding/onboard-yahoo.png"/>
                  <span>
                    <div class='connected'></div>
                    <button id='yahoo' type="Submit" class="button teal">Connect Yahoo! Mail</button>
                  </span>
                </div>
                <div id='windows-area' class="connect-email">
                  <img src="https://s3-us-west-2.amazonaws.com/advisorconnect/images/onboarding/onboard-windows.png"/>
                  <span>
                    <div class='connected'></div>
                    <button id='windowslive' type="Submit" class="button teal">Connect Windows Live</button>
                  </span>
                </div>
              </div>
            </div>
          </div>
          <div class="onboard-footer"><small>

              Can’t add your email contacts? <a href="#">Click here.</a></small>
            <button  data-next='3' class="button dark-blue">Next</button>
          </div>
        </div>
        <!-- Onboard Step 4-->
        <div class="onboard" id="step-4">
          <div class="wizard">
            <ol>
              <li class="complete"> 
                <label>Step One</label>
                <p>Signin Via LinkedIn</p>
              </li>
              <li class="complete">
                <label>Step Two</label>
                <p>Add LinkedIn Contacts</p>
              </li>
              <li class="complete"> 
                <label>Step Three</label>
                <p>Add Email Contacts</p>
              </li>
              <li>
                <label>Step Four</label>
                <p>Finish & Upload</p>
              </li>
            </ol>
          </div>
          <div class="onboard-body">
            <div class="wrap">
              <div class="col-6">
                <div class="note">
                  <h2>Congratulations!</h2>
                  <p>You’ve successfully uploaded <span class='final-contact-count'></span> Contacts!</p>
                </div>
              </div>
              <div class="col-5" id='thanks'>
                <div id='next' class="button large fluid dark-blue">Finish</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <input name=_csrf_token type=hidden value="{{ csrf_token() }}">
  <script type='text/javascript' >

    var domain_key='VB652MMUEG24H4JF3SGL';
    var domain_password='GSrAxStb9Zk5EOmD';    
    var cloudsponge_params = 'domain_key=' + domain_key + '&domain_password=' + domain_password;
    var cloudsponge_base_url = 'https://api.cloudsponge.com/'    ;
    var contacts_array = [];
    var test = (window.location.href.indexOf("testing") > -1) ? true : false;

    function do_import(service, divid, win) {     
      $.getJSON(cloudsponge_base_url + 'begin_import/user_consent.json?service=' + service + '&' + cloudsponge_params + '&callback=?', 
        function(data) {
          var cloudsponge_url = data.url;
          var import_id = data.import_id;
          var tempcontactsurl = cloudsponge_base_url + 'contacts.json/' + import_id + '?' + cloudsponge_params + '&callback=?';
          var tempeventsurl = cloudsponge_base_url + 'events.json/' + import_id + '?' + cloudsponge_params + '&callback=?';
          console.log(tempcontactsurl);
          win.location = cloudsponge_url;
          //var win = window.open(cloudsponge_url);
          var timer = setInterval(function() {   
              if(win.closed) {
                  console.log("window closed");
                  $(".overlay").fadeIn();
                  $(".waiting").show();                
                  clearInterval(timer); 
                  $.getJSON(tempeventsurl, function(data){
                    events = data.events;

                    for (i = 0; i < events.length; i++) { 
                        cloudsponge_status = events[i].status;
                        if (cloudsponge_status == 'COMPLETED') {
                          var timer2 = setInterval(function() {  
                            $.getJSON(tempcontactsurl, function() {
                            })
                            .success(function(data) {
                              clearInterval(timer2); 
                              contacts = data.contacts;
                              if (contacts !=undefined && contacts.length) { 
                                contacts_owner = data.contacts_owner;
                                
                                if (contacts_owner) {
                                  response_element_id = contacts_owner.email[0].address + "_response";
                                } else {
                                  response_element_id = service + "_response"
                                }
                                status_field = document.getElementById(response_element_id);
                                if (status_field == null || status_field == undefined) {
                                  for (i = 0; i < contacts.length; i++) { 
                                      var contact = contacts[i];
                                      contacts_array.push({contact:contact, contacts_owner:contacts_owner, service:service});
                               
                                  }
                                  var response_string = contacts.length.toLocaleString() + " " +  service + " contacts added ";
                                  if (contacts_owner) {
                                    response_string = response_string + "from " + contacts_owner.email[0].address;
                                  }

                                  $(".contact-count").find("small").html(contacts_array.length.toLocaleString() + " Total Contacts Added")
                                  $(".final-contact-count").html(contacts_array.length.toLocaleString())
                                  $(".contact-count").show();

                                  if(divid == "div#linkedin_area") {
                                    $("#step-2").hide();
                                    $("#step-3").slideDown();     
                                  } else {
                                    // $(divid).find("button").hide()
                                    $(divid).find(".connected").html(contacts.length.toLocaleString() + ' Total Contacts Added').attr('style', 'display:block;')
                                  }
                                  $(".waiting").hide();
                                  $(".overlay").fadeOut();
                                }
                                else {
                                  $(".waiting").hide();   
                                  $(".overlay").fadeOut();     
                                  alert("You already added your contacts from this account.")                                  
                                }
                                contacts = [];
                                return;
                              } 
                              else {
                                $(".waiting").hide();   
                                $(".overlay").fadeOut();                                
                                alert('Invalid input');
                              }                             
                            });                          
                          }, 1000); 
                          break;
                        } else if (cloudsponge_status =="ERROR") {
                            $(".waiting").hide();   
                            $(".overlay").fadeOut();      
                            break;                       
                        }
                    }     
                  }); 
              }  
          }, 500);             
        });      
    }

    $(function() {

      $("#enter").click(function() {
        email_address = document.getElementById("email_address").value;
        geolocation = document.getElementById("geolocation").value;
        if (email_address != "" && geolocation != "") {
          document.getElementById("owner_email").innerHTML = email_address;
          document.getElementById("owner_geolocation").innerHTML = geolocation;
          $("div#enter_email").hide();
          $("div#upload_area").show();
        }
      });

      $("#vcard").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        cloudsponge_status = 'NONE';   
        var len = do_import('addressbook','div#mac_area',win);
      });


      $("#ln").click(function(e) {
        e.preventDefault();
        var win = window.open('');
        // $(".overlay").fadeIn();
        var len = do_import('LinkedIn','div#linkedin_area',win);
        //TODO hide linkedin button
      });

      $("#csv").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        // $(".overlay").fadeIn();
        var len = do_import('CSV','div#csv_area',win);
        // if (len>0) {$("#csv").hide();}
      });

      $("[data-next]").click(function() {
        var id = $(this).data('next');
        var next_id = id + 1;
        $("#step-" + id).hide()
        $("#step-" + next_id).slideDown()
      });

      $("#next").click(function() {
        if (contacts_array.length > 0) {
          $(".overlay").fadeIn();
          $(".waiting").show();   
          var csrf_token = $("[_csrf_token]").val()
          if (test) {
            contacts_array = contacts_array.slice(0, 20)
          }

          var outData = {csrf_token:csrf_token, geolocation:geolocation, firstName: firstName, lastName:lastName, public_url:public_url, user_email:email_address, contacts_array: contacts_array, image_url:$("#owner_img").attr("src")}          
          $.ajax({
              type: 'POST',
              url: '/upload_cloudsponge',
              crossDomain: true,
              data: JSON.stringify(outData),
              dataType: 'json',
              contentType: 'application/json; charset=utf-8',
              success: function(responseData, textStatus, jqXHR) {
                $("#thanks").append("<h2>Thanks!</h2><p>We will be emailing you when the results are ready. Thank you!</p>")
                $("#next").hide()
                $(".waiting").hide();   
                $(".overlay").fadeOut();     
              },
              error: function (responseData, textStatus, errorThrown) {
                  debugger;
                  $(".waiting").hide();   
                  $(".overlay").fadeOut();                
                  alert('upload failed.');
              }
          });   
        } else {
          alert('No contacts added!');
        }     
        //$("#csv").hide();
      });

      $(".overlay").click(function(e) {
        if (e.target.className == "overlay") {
            $(".linkedin").hide();
            $(".email").hide();
            $(this).hide();
          }
      });

      bindEmailButtons()
    });

  function bindEmailButtons() {
      $("button#gmail").click(function(e) {
        cloudsponge_status = 'NONE';   
        e.preventDefault();
        var win = window.open('');        
        var len = do_import('Gmail','#gmail-area',win);
        $(".email").hide();
        // if (len>0) {$("#gmail").hide();}
        $(".overlay").fadeOut();
      });

      $("button#yahoo").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        cloudsponge_status = 'NONE';   
        var len =do_import('Yahoo','#yahoo-area',win);
        $(".email").hide();
        // if (len>0) { $("#yahoo").hide();}
        $(".overlay").fadeOut();
      });

      $("button#windowslive").click(function(e) {
        e.preventDefault();
        var win = window.open('');        
        cloudsponge_status = 'NONE';   
        var len = do_import('WindowsLive','#windows-area',win);
        $(".email").hide();
        // if (len>0) {$("#windowslive").hide();}
        $(".overlay").fadeOut();
      });
  }
  </script>
  {% endblock %}
