{% extends 'base.html' %}
{% block content %}
{% with header="Project 200" %}
{% include "_partials/agent_header.html" %}

{% endwith %}

<div class="section">
  
  <div class="wrap">
    <div class="col-9">
      <div class="filters">
        <span>
          <select name='stars'>
            <option value=''>Any Rating</option>
            <option value='5'>Five Stars</option>
            <option value='4'>Four Stars</option>
            <option value='3'>Three Stars</option>
            <option value='2'>Two Stars</option>
            <option value='1'>One Star</option>
          </select>
        </span>
        <span>
          <select name='market' id='market'>
            <option value=''>Any Industry</option>
            {% for industry in agent.industries %}
            <option value='{{ industry[0] }}'>{{ industry[0] }}</option>
            {% endfor %}
          </select>
        </span>
        <span>
          <select name='state' id='state'>
            <option value=''>Any State</option>
            {% for state in agent.states %}
            <option value='{{ state[0] }}'>{{ state[0] }}</option>
            {% endfor %}
          </select>
        </span>        
        <span>
          <label data-sort='a-z' class="sort-abc sort-down active">A - Z</label>
          <label data-sort='z-a' class="sort-abc sort-down active">Z - A</label>
        </span>
      </div>
    </div>
    <div class="col-3">
      <div class="search">
        <input type="search" name='search-box' id='search-box' placeholder="Search By Name"/>
        <button id="search-button"></button>
      </div>
    </div>
  </div>
  <hr/>


  <div class="wrap">
    <div class="col-12">
      <div class="search">
        {% if current_user.is_manager %}
          {% if agent.p200_approved %}
<!--             <h2>Approved P200</h2> -->
            <a href='/managers/pdf/{{ agent.user_id }}'><button id='export' class='button dark-blue'>Export as PDF</button></a>
          {% else %}
            <a href='/managers/approve/{{ agent.user_id }}'><button class='button teal'>Approve This P200 For Export</button></a>
          {% endif %}
        {% else %}
          {% if current_user.p200_submitted_to_manager and current_user.p200_approved %}
            <a href='/export'><button class='button grey'>Export to MOD</button></a>
            <a href='/contacts_export'><button class='button grey'>Export Contact Info</button></a>
            <a href='pdf'><button id='export' class='button dark-blue'>Export as PDF</button></a>
          {% endif %}
          {% if not current_user.p200_submitted_to_manager and not current_user.p200_approved %}
            <button id='submit' class='button teal'>Submit For Approval</button>
          {% endif %}
<!--           <button class='button teal'>View Skipped Connections</button> -->
        {% endif %}
      </div>
    </div>
  </div>
</div>
<div class="section" id='connections-section'>
  <div class="wrap" id='connections'>
    {% include "_partials/connections_table.html" %}
  </div>
</div>


<script type='text/javascript'>

  $("button#submit").click(function() {
    $.post("/submit_p200_to_manager", function(data) {
      if (data.error) {
        showSuccess("Error: " + data.error);
        return false;
      } else {
        showSuccess("Your Project 200 has been submitted to your manager for approval. You will receive an alert when it is confirmed.");
        $("button#submit").hide();
      }
    });
  });

</script>

<script type='text/javascript'>
$(function() {
   var $industry = $("[name='market']");
   var $state = $("[name='state']")
   var $stars = $("[name='stars']");
   var $query = $("[name='search-box']");
   var $order = 'a-z';
   var $page = 1;
   var isSearching = false;

   if ($industry.val()=='' && window.location.search.indexOf("industry=")>0) {
      var industry_name = window.location.search.split("industry=")[window.location.search.split("industry=").length - 1];
      document.getElementById("market").value = decodeURIComponent(industry_name);
      showLoader()
      search()      
   }

   if ($state.val()=='' && window.location.search.indexOf("state=")>0) {
      var state_name = window.location.search.split("state=")[window.location.search.split("state=").length - 1];
      document.getElementById("state").value = decodeURIComponent(state_name);
      showLoader()
      search()      
   }

   if ($query.val()=='' && window.location.search.indexOf("query=")>0) {
      var query_name = window.location.search.split("query=")[window.location.search.split("query=").length - 1];
      document.getElementById("search-box").value = decodeURIComponent(query_name);
   } else {
      document.getElementById("search-box").value = '';
   }

   $("[name='search-box']").keyup(function() {
     delay(function(){
       showLoader()
       search()
    }, 1000 );
   });

   $("label.sort-abc").click(function() {
     $order = $(this).data("sort");
     showLoader()
     search()
   });

  function bindStars() {
     $("[name='stars']").change(function() {
       showLoader()
       search()
     });
   }

   function bindMarket() {
     $("[name='market']").change(function() {
       showLoader()
       search()
     });
   }

   function bindState() {
     $("[name='state']").change(function() {
       showLoader()
       search()
     });
   }

   function bindPagination() {
     $("[data-page]").click(function() {
       showLoader()
       $page = $(this).data('page');
       search()
     });
   }

   function bindPageFunctions() {
     addConnection();
     skipConnection();
     addAll();
     skipAll();
     selectAll();
     bindStars()
     bindMarket()
     bindState()
     bindPagination()
   }

    var delay = (function(){
    var timer = 0;
    return function(callback, ms){
      clearTimeout (timer);
      timer = setTimeout(callback, ms);
    };
    })();
 

   function showLoader() {
     $(".loading").show();
   }

   function hideLoader() {
     $(".loading").fadeOut();
   }

  function search() {
     if (isSearching) {
       return false;
     }
     isSearching = true;
     $('html, body').animate({scrollTop: "221px"});
     $("#connections-section").load(window.location.pathname + "?query=" + encodeURIComponent($query.val()) + "&industry=" + encodeURIComponent($industry.val()) + "&state=" + encodeURIComponent($state.val()) + "&stars=" + encodeURIComponent($stars.val()) + "&order=" + $order + "&p=" + $page + " #connections", function() {
         isSearching = false;
         bindPageFunctions();
         $("[data-page]").removeClass("active")
         $("[data-page='" + $page + "']").addClass("active")
         hideLoader();
     });
  }

  function addConnection() {
    $("[data-add]").click(function() {
        var id = $(this).data("add");
        var params = {id: id}
        //var n = agent.p200_count;
        $.post("/add-connections", params, function() {
          $("[data-row=" + id + "]").slideUp();
          window.location.reload(true);
        });
    });
  }

  function skipConnection() {
    $("[data-skip]").click(function() {
        var id = $(this).data("skip");
        var params = {id: id}
        $.post("/skip-connections", params, function() {
          $("[data-row=" + id + "]").slideUp();
        });
    });
  }

  function addAll() {
    $("#add-all").click(function() {
        var ids = $(".connection-checkbox:checked").map(function () {
          return $(this).data("connection-id");
        }).get();
        var ids = ids.join()
        var params = {id:ids, multi:true}
        $.post("/add-connections", params, function() {
          var saved = ids.split(",");
          for (var j=0;j<saved.length;j++) {
            $("[data-row='" + saved[j] + "']").slideUp();
          }
          window.location.reload(true);
        });
    });
  }

  function skipAll() {
    $("#skip-all").click(function() {
        var ids = $(".connection-checkbox:checked").map(function () {
          return $(this).data("connection-id");
        }).get();
        var ids = ids.join()
        var params = {id:ids, multi:true}
        $.post("/skip-connections", params, function() {
          var saved = ids.split(",")
          for (var j=0;j<saved.length;j++) {
            $("[data-row='" + saved[j] + "']").slideUp();
          }
        });
    });
  }

  function selectAll() {
    $("[name='select-all']").click(function() {
        if ($(this).is(":checked")) {
          $(".connection-checkbox").prop("checked", true)
        } else {
          $(".connection-checkbox").prop("checked", false)
        }
    });
  }
  hideLoader()
  bindPageFunctions()
  
 });
</script>

{% endblock %}

