{% extends 'base.html' %}
{% block header %}{% endblock %}

{% block content %}

<div id="linkedin_password_form">
  <form class="card" id='linkedin-login-form' method='POST' autocomplete="false">
    <header>
      <div class="header-logo"></div>
    </header>
    <h3>Please enter your Linkedin username (email) and password so we can securely connect your contacts.</h3>
    <hr>

    {{ form.csrf_token }}

    <div class="col-8">
      <input type="email" name='email' class="form-control" id="inputEmail" placeholder="Enter Your LinkedIn Email Address" autocomplete="new-email">
    </div>
    <div class="col-8">
      <input type="password" name='password' class="form-control" id="inputPassword" placeholder="Enter Your LinkedIn Password" autocomplete="new-password">
    </div>
    <div class="col-4">
      <button id="check_linkedin_button" type="submit" class="button fluid linkedin">Connect Linkedin Contacts</button>
    </div>
    <div>
      <small>
        <a href='https://www.linkedin.com/uas/request-password-reset?trk=uno-reg-guest-home-forgot-password' target="_blank">Forgot Your Linkedin Password?</a>
      </small>
    </div>
  </form>
</div>
<script type="text/javascript">
  $(function(){

    function finishMe() {
      $('#overlay', window.parent.document).hide();
      window.close();      
    }

    var listening;

    function didLinkedinLoginWork() {
      //this will check redis, which is where the login task publishes its results 
      $.get("/linkedin_login_status", function(data){
        //the task had some outcome, good or bad
        if (data.finished) {
          var error = data.error;
          //it logged in
          if (data.success) {
            finishMe();
          } 
          //it sent a pin to the user's email. the "error" just says the email account that the pin was sent to
          else if (data.pin) {
            window.location.href = '/linkedin_pin?message=' + error;
          } else {
            clearInterval(listening);
            $(".overlay").fadeOut();
            $(".waiting").hide();
            //linkedin told us what was wrong, we will pass the message along
            if (error.length > 0) {
              showSuccess(error);
            }
            //no frickin clue what happened, just act like everything ok and move along
            else {
              finishMe();
            }
          }
        } else {
          console.log("Not Finished")
        }
      })
    }

    //the linkedin credentials checker task will publish results when it is finished, so we are listening for them
    function listenForSuccess() {
      listening = setInterval(function() {
        didLinkedinLoginWork()
      }, 1000);
    }

    //user clicks the button to submit credentials
    $("#linkedin-login-form").submit(function(e){
      //prevent form from giving its status
      e.preventDefault();
      $(".overlay").fadeIn();
      $(".waiting").show();
      var data = {email:$("#inputEmail").val(),password:$("#inputPassword").val()}
      $.post("/linkedin_login", data, function(data){
        if (data.success) {
          //view has launched a task to try the login
          //the task will publish results when it is finished, so we are listening for them
          listenForSuccess()
        } else {
          //view returns false if one of the args is missing
          showSuccess("You must enter Email and Password.")
        }
      });
    });

  });
</script>
{% endblock %}





{% block footer %}{% endblock %}
